<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hngy.cvs.mapper.NotificationMapper">

    <!-- 结果映射 -->
    <resultMap id="BaseResultMap" type="com.hngy.cvs.entity.Notification">
        <id column="id" property="id" jdbcType="BIGINT"/>
        <result column="user_id" property="userId" jdbcType="BIGINT"/>
        <result column="type" property="type" jdbcType="VARCHAR"/>
        <result column="title" property="title" jdbcType="VARCHAR"/>
        <result column="content" property="content" jdbcType="LONGVARCHAR"/>
        <result column="link_url" property="linkUrl" jdbcType="VARCHAR"/>
        <result column="is_read" property="isRead" jdbcType="TINYINT"/>
        <result column="created_time" property="createdTime" jdbcType="TIMESTAMP"/>
        <result column="read_time" property="readTime" jdbcType="TIMESTAMP"/>
    </resultMap>

    <!-- 基础字段 -->
    <sql id="Base_Column_List">
        id, user_id, type, title, content, link_url, is_read, created_time, read_time
    </sql>

    <!-- 获取用户未读通知数量 - 使用覆盖索引 idx_user_read_created 优化查询 -->
    <select id="countUnreadByUserId" resultType="java.lang.Long">
        SELECT /*+ USE_INDEX(notification_twb, idx_user_read_created) */ COUNT(*)
        FROM notification_twb
        WHERE user_id = #{userId}
          AND is_read = 0
    </select>

    <!-- 分页查询用户通知列表 - 优化排序和索引使用 -->
    <select id="selectNotificationPage" resultMap="BaseResultMap">
        <choose>
            <!-- 当有类型筛选时，使用类型索引 -->
            <when test="type != null">
                SELECT /*+ USE_INDEX(notification_twb, idx_user_type_read) */
                <include refid="Base_Column_List"/>
                FROM notification_twb
                WHERE user_id = #{userId}
                  AND type = #{type}
                <if test="isRead != null">
                  AND is_read = #{isRead}
                </if>
                ORDER BY 
                    CASE WHEN is_read = 0 THEN 0 ELSE 1 END,
                    created_time DESC
            </when>
            <!-- 默认查询使用覆盖索引 -->
            <otherwise>
                SELECT /*+ USE_INDEX(notification_twb, idx_user_read_created) */
                <include refid="Base_Column_List"/>
                FROM notification_twb
                WHERE user_id = #{userId}
                <if test="isRead != null">
                  AND is_read = #{isRead}
                </if>
                ORDER BY 
                    CASE WHEN is_read = 0 THEN 0 ELSE 1 END,
                    created_time DESC
            </otherwise>
        </choose>
    </select>

    <!-- 批量标记用户所有通知为已读 - 使用索引优化更新 -->
    <update id="markAllAsReadByUserId">
        UPDATE /*+ USE_INDEX(notification_twb, idx_user_read_created) */ notification_twb
        SET is_read = 1,
            read_time = NOW()
        WHERE user_id = #{userId}
          AND is_read = 0
    </update>

    <!-- 删除用户所有已读通知 - 使用索引优化删除 -->
    <delete id="deleteReadNotificationsByUserId">
        DELETE /*+ USE_INDEX(notification_twb, idx_read_user_created) */ FROM notification_twb
        WHERE user_id = #{userId}
          AND is_read = 1
    </delete>

    <!-- 获取用户各类型通知的未读数量统计 - 使用类型索引优化 -->
    <select id="countUnreadByTypeAndUserId" resultType="java.util.Map">
        SELECT /*+ USE_INDEX(notification_twb, idx_user_type_read) */
            type,
            COUNT(*) as count
        FROM notification_twb
        WHERE user_id = #{userId}
          AND is_read = 0
        GROUP BY type
        ORDER BY type
    </select>

    <!-- 批量标记指定通知为已读 -->
    <update id="batchMarkAsRead">
        UPDATE notification_twb
        SET is_read = 1,
            read_time = NOW()
        WHERE user_id = #{userId}
          AND id IN
        <foreach collection="notificationIds" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
          AND is_read = 0
    </update>

    <!-- 高级筛选查询通知列表 - 支持复杂筛选条件和性能优化 -->
    <select id="selectNotificationPageAdvanced" resultMap="BaseResultMap">
        <choose>
            <!-- 当有时间范围查询时，优先使用时间索引 -->
            <when test="startTime != null or endTime != null">
                SELECT /*+ USE_INDEX(notification_twb, idx_user_created_read) */
                <include refid="Base_Column_List"/>
                FROM notification_twb
                WHERE user_id = #{userId}
                <if test="startTime != null">
                  AND created_time >= #{startTime}
                </if>
                <if test="endTime != null">
                  AND created_time &lt;= #{endTime}
                </if>
                <if test="types != null and types.size() > 0">
                  AND type IN
                  <foreach collection="types" item="type" open="(" separator="," close=")">
                      #{type}
                  </foreach>
                </if>
                <if test="isRead != null">
                  AND is_read = #{isRead}
                </if>
                ORDER BY 
                    CASE WHEN is_read = 0 THEN 0 ELSE 1 END,
                    created_time DESC
            </when>
            <!-- 当有类型筛选时，使用类型索引 -->
            <when test="types != null and types.size() > 0">
                SELECT /*+ USE_INDEX(notification_twb, idx_user_type_read) */
                <include refid="Base_Column_List"/>
                FROM notification_twb
                WHERE user_id = #{userId}
                  AND type IN
                  <foreach collection="types" item="type" open="(" separator="," close=")">
                      #{type}
                  </foreach>
                <if test="isRead != null">
                  AND is_read = #{isRead}
                </if>
                ORDER BY 
                    CASE WHEN is_read = 0 THEN 0 ELSE 1 END,
                    created_time DESC
            </when>
            <!-- 默认查询使用覆盖索引 -->
            <otherwise>
                SELECT /*+ USE_INDEX(notification_twb, idx_user_read_created) */
                <include refid="Base_Column_List"/>
                FROM notification_twb
                WHERE user_id = #{userId}
                <if test="isRead != null">
                  AND is_read = #{isRead}
                </if>
                ORDER BY 
                    CASE WHEN is_read = 0 THEN 0 ELSE 1 END,
                    created_time DESC
            </otherwise>
        </choose>
    </select>

</mapper>