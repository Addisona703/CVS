<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hngy.cvs.mapper.ActivityMapper">

    <!-- 每日统计数据结果映射 -->
    <resultMap id="DailyStatisticsVOMap" type="com.hngy.cvs.dto.response.DailyStatisticsVO">
        <result column="date" property="date"/>
        <result column="activity_count" property="activityCount"/>
        <result column="participant_count" property="participantCount"/>
    </resultMap>

    <!-- 获取每日活动统计数据 -->
    <select id="getDailyStatistics" resultMap="DailyStatisticsVOMap">
        WITH RECURSIVE date_series AS (
            SELECT DATE(#{startDate}) as date
            UNION ALL
            SELECT DATE_ADD(date, INTERVAL 1 DAY)
            FROM date_series
            WHERE date &lt; DATE(#{endDate})
        ),
        daily_activities AS (
            SELECT 
                DATE(start_time) as activity_date,
                COUNT(DISTINCT id) as activity_count
            FROM activity_twb
            WHERE deleted = 0
                AND status = 'PUBLISHED'
                AND start_time BETWEEN #{startDate} AND #{endDate}
            GROUP BY DATE(start_time)
        ),
        daily_participants AS (
            SELECT 
                DATE(a.start_time) as activity_date,
                COUNT(DISTINCT s.user_id) as participant_count
            FROM signup_twb s
            INNER JOIN activity_twb a ON s.activity_id = a.id
            WHERE s.status = 'APPROVED'
                AND a.deleted = 0
                AND a.start_time BETWEEN #{startDate} AND #{endDate}
            GROUP BY DATE(a.start_time)
        )
        SELECT 
            ds.date as date,
            COALESCE(da.activity_count, 0) as activity_count,
            COALESCE(dp.participant_count, 0) as participant_count
        FROM date_series ds
        LEFT JOIN daily_activities da ON ds.date = da.activity_date
        LEFT JOIN daily_participants dp ON ds.date = dp.activity_date
        ORDER BY ds.date ASC
    </select>

</mapper>
